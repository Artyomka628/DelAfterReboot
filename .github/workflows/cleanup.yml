name: Actions cleanup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup actions history
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          CURRENT_RUN_ID: ${{ github.run_id }}
          WORKFLOW_NAME: Actions cleanup
        run: |
          runs=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs?per_page=100")

          echo "$runs" | jq -r '
            .workflow_runs[]
            | select(
                (
                  .conclusion == "failure"
                  or .conclusion == "cancelled"
                  or (.name == "'"$WORKFLOW_NAME"'")
                )
                and (.id != '"$CURRENT_RUN_ID"')
              )
            | .id
          ' | while read run_id; do
              echo "Deleting run $run_id"
              curl -s -X DELETE \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/actions/runs/$run_id"
            done

            
