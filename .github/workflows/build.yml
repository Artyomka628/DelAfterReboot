name: Build MSI and Release

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Publish to GitHub Release?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"
  push:
    branches:
      - main
    paths:
      - 'delafterreboot.cpp'
      - '.github/workflows/build.yml'

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  build-x86-x64:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_package: mingw-w64-i686-gcc
          - arch: x64
            msystem: MINGW64
            mingw_package: mingw-w64-x86_64-gcc

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: ${{ matrix.mingw_package }}

      - name: Build EXE with MinGW-w64
        shell: msys2 {0}
        run: |
          mkdir -p dist
          g++ -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32

      - name: Prepare Installer Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path installer -Force
          Move-Item -Path "dist/delafterreboot.exe" -Destination "installer/delafterreboot.exe" -Force

      # WiX is pre-installed on windows-latest, no need to install it.
      - name: Build MSI Package
        shell: pwsh
        run: |
          $arch = '${{ matrix.arch }}'
          Write-Host "Building MSI for architecture: $arch"
          
          # We run from repo root. Passing full relative path to EXE via variable.
          candle installer\Product-$arch.wxs -ext WixUIExtension -dDelExePath="installer\delafterreboot.exe" -out installer\
          light installer\Product-$arch.wixobj -ext WixUIExtension -o installer\DelAfterReboot-$arch.msi -b installer
      
      - name: Attest MSI provenance
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
          (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: installer/DelAfterReboot-${{ matrix.arch }}.msi
          
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-${{ matrix.arch }}
          path: installer/DelAfterReboot-${{ matrix.arch }}.msi

  build-arm64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install llvm-mingw (ARM64)
        shell: pwsh
        run: |
          $version = "20231011"
          $zipName = "llvm-mingw-$version-ucrt-x86_64.zip"
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$version/$zipName"
          $zipPath = Join-Path $env:RUNNER_TEMP $zipName
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $env:RUNNER_TEMP -Force
          $toolchain = Join-Path $env:RUNNER_TEMP "llvm-mingw-$version-ucrt-x86_64"
          Add-Content $env:GITHUB_PATH "$toolchain\\bin"

      - name: Build EXE with llvm-mingw (ARM64)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          aarch64-w64-mingw32-clang++ -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32

      - name: Prepare Installer Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path installer -Force
          Move-Item -Path "dist/delafterreboot.exe" -Destination "installer/delafterreboot.exe" -Force

      - name: Install WiX Toolset
        run: choco install wixtoolset --no-progress -y

      - name: Build MSI for ARM64
        shell: pwsh
        run: |
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
          
          Write-Host "Building MSI for ARM64 using path: $wixPath"
          
          & "$wixPath\candle.exe" installer\Product-arm64.wxs -ext WixUIExtension -dDelExePath="installer\delafterreboot.exe" -out installer\
          & "$wixPath\light.exe" installer\Product-arm64.wixobj -ext WixUIExtension -o installer\DelAfterReboot-arm64.msi -b installer
     
      - name: Attest MSI provenance (ARM64)
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
          (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: installer/DelAfterReboot-arm64.msi
          
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-arm64
          path: installer/DelAfterReboot-arm64.msi

  release:
    runs-on: ubuntu-latest
    needs: [build-x86-x64, build-arm64]
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
    steps:
      - uses: actions/checkout@v4

      - name: Download all MSI artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Read Release Info
        id: releaseinfo
        shell: bash
        run: |
          version=$(jq -r '.version // empty' release.json)
          notes=$(jq -r '.notes | join("\n")' release.json)
          if [ -z "$version" ]; then
            echo "Version not found in release.json" >&2
            exit 1
          fi
          echo "VERSION=$version" >> "$GITHUB_ENV"
          {
            echo "NOTES<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: ${{ env.NOTES }}
          files: dist/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLISH_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [build-x86-x64, build-arm64]
    if: always()
    steps:
      - name: Build Notification Message
        id: build_msg
        run: |
          WORKFLOW_NAME="${{ github.workflow }}"
          REPO="${{ github.repository }}"
          STATUS="${{ needs.build-x86-x64.result }}-${{ needs.build-arm64.result }}"
          URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [[ "$STATUS" == "success-success" ]]; then
            MESSAGE=$'✅ Workflow *'"${WORKFLOW_NAME}"'* completed successfully.\nRepository: '"${REPO}"'\n[View Workflow]('"${URL}"')'
          else
            MESSAGE=$'❌ Workflow *'"${WORKFLOW_NAME}"'* finished with status: *'"${STATUS}"'*\nRepository: '"${REPO}"'\n[View Workflow]('"${URL}"')'
          fi

          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          MESSAGE: ${{ steps.build_msg.outputs.message }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT}" \
            --data-urlencode "text=${MESSAGE}" \
            -d parse_mode="Markdown"
