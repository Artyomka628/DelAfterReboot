name: Build MSI and Release

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Publish to GitHub Release?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"
  push:
    branches:
      - main
    paths:
      - 'delafterreboot.cpp'
      - '.github/workflows/build.yml'

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  build-and-release:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            compiler: gcc
          - arch: x64
            msystem: MINGW64
            compiler: gcc
          - arch: arm64
            msystem: MINGW64
            compiler: aarch64-clang

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 / llvm-mingw
        shell: pwsh
        run: |
          if ('${{ matrix.arch }}' -eq 'arm64') {
            $api = "https://api.github.com/repos/mstorsjo/llvm-mingw/releases/latest"
            $release = Invoke-RestMethod $api
            $asset = $release.assets | Where-Object { $_.name -like "*aarch64*ucrt.zip" }
            if (-not $asset) { Write-Error "ARM64 llvm-mingw not found"; exit 1 }
            $zipPath = Join-Path $env:RUNNER_TEMP $asset.name
            Invoke-WebRequest $asset.browser_download_url -OutFile $zipPath
            Expand-Archive $zipPath -DestinationPath $env:RUNNER_TEMP -Force
            $toolchainDir = Join-Path $env:RUNNER_TEMP ($asset.name -replace ".zip","")
            Add-Content $env:GITHUB_PATH "$toolchainDir\bin"
          } else {
            # MSYS2 для x86/x64
            Invoke-Expression "iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/msys2/setup-msys2/master/setup-msys2.ps1'))"
            pacman -Syu --noconfirm
            pacman -S --noconfirm $([System.String]::Format('mingw-w64-{0}-gcc', if ('${{ matrix.arch }}' -eq 'x86'){ 'i686' } else { 'x86_64' }))
          }

      - name: Generate version header without Python
        shell: pwsh
        run: |
          $version = "unknown"
          $commit = "unknown"
          $date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")

          if (Test-Path release.json) {
              $json = Get-Content release.json | ConvertFrom-Json
              if ($json.version) { $version = $json.version }
          }
          try { $commit = git rev-parse --short HEAD } catch {}
          
          "pragma once" | Out-File version.h -Encoding utf8
          "#define APP_VERSION `"$version`"" | Out-File version.h -Append -Encoding utf8
          "#define GIT_COMMIT_HASH `"$commit`"" | Out-File version.h -Append -Encoding utf8
          "#define BUILD_DATE `"$date`"" | Out-File version.h -Append -Encoding utf8

      - name: Build EXE
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          
          if ('${{ matrix.arch }}' -eq 'arm64') {
            aarch64-w64-mingw32-clang++ -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32
          } else {
            if ('${{ matrix.arch }}' -eq 'x86') { $msysbin="C:/msys64/mingw32/bin" } else { $msysbin="C:/msys64/mingw64/bin" }
            & "$msysbin/g++.exe" -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32
          }

      - name: Prepare Installer Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path installer -Force | Out-Null
          Move-Item -Path "dist/delafterreboot.exe" -Destination "installer/delafterreboot.exe" -Force

      - name: Install WiX Toolset
        run: choco install wixtoolset --no-progress -y

      - name: Build MSI
        shell: pwsh
        run: |
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
          $arch = '${{ matrix.arch }}'
          & "$wixPath\candle.exe" "installer\Product-$arch.wxs" -ext WixUIExtension -dDelExePath="installer\delafterreboot.exe" -out "installer\$arch.wixobj"
          & "$wixPath\light.exe" "installer\$arch.wixobj" -ext WixUIExtension -o "installer\DelAfterReboot-$arch.msi" -b installer

      - name: Attest MSI provenance
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
          (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: installer/DelAfterReboot-${{ matrix.arch }}.msi

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-${{ matrix.arch }}
          path: installer/DelAfterReboot-${{ matrix.arch }}.msi

      - name: Create GitHub Release & Notify
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
          (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
        shell: pwsh
        run: |
          $version = (Get-Content release.json | ConvertFrom-Json).version
          $notes = (Get-Content release.json | ConvertFrom-Json).notes -join "`n"

          gh release create "v$version" "installer/DelAfterReboot-*.msi" --title "v$version" --notes "$notes"

          # Telegram notification
          $status = if ($LASTEXITCODE -eq 0) { "✅ Build & Release succeeded" } else { "❌ Build failed" }
          $message = "Repository: $env:GITHUB_REPOSITORY`nWorkflow: $env:GITHUB_WORKFLOW`nStatus: $status`n[View Run]($env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/actions/runs/$env:GITHUB_RUN_ID)"
          Invoke-RestMethod -Method Post -Uri "https://api.telegram.org/bot$($env:TELEGRAM_BOT_TOKEN)/sendMessage" -Body @{ chat_id = $env:TELEGRAM_CHAT_ID; text = $message; parse_mode = "Markdown" }
