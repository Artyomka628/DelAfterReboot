name: Build MSI and Release

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Publish to GitHub Release?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"
  push:
    branches:
      - main
    paths:
      - 'del.py'

jobs:
  build-x86-x64:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.arch }}

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build del.exe with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --onefile --console --icon=icon.ico del.py --name del-${{ matrix.arch }}.exe

      - name: Prepare build directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build
          Move-Item -Path "dist/del-${{ matrix.arch }}.exe" -Destination "build/del.exe" -Force


      - name: Move del.exe to installer folder
        shell: pwsh
        run: |
          $installerFolder = "$env:GITHUB_WORKSPACE\installer"
          if (-not (Test-Path $installerFolder)) { New-Item -ItemType Directory -Path $installerFolder }
          Move-Item -Path "$env:GITHUB_WORKSPACE\build/del.exe" -Destination $installerFolder -Force

      - name: Install WiX
        run: choco install wixtoolset --no-progress -y

      - name: Build MSI
        shell: pwsh
        run: |
          Set-Location $env:GITHUB_WORKSPACE
          if ('${{ matrix.arch }}' -eq 'x64') {
              $archFlag = 'x64'
          } else {
              $archFlag = 'x86'
          }
          Write-Host "Building MSI for architecture: $archFlag"
          candle installer\Product-$archFlag.wxs -ext WixUIExtension -dDelExePath="$env:GITHUB_WORKSPACE\installer\del.exe" -out installer\
          light installer\Product-$archFlag.wixobj -ext WixUIExtension -o installer\DelAfterReboot-${archFlag}.msi -b installer


      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-${{ matrix.arch }}
          path: installer/DelAfterReboot-${{ matrix.arch }}.msi

  build-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ARM64
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: "arm64"

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build del.exe for ARM64
        shell: pwsh
        run: |
          pyinstaller --onefile --console --icon=icon.ico del.py --name del.exe

      - name: Prepare build directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build
          Move-Item -Path "dist/del.exe" -Destination "build/del.exe" -Force

      - name: Move del.exe to installer folder
        shell: pwsh
        run: |
          $installerFolder = "$env:GITHUB_WORKSPACE\installer"
          if (-not (Test-Path $installerFolder)) { New-Item -ItemType Directory -Path $installerFolder }
          Move-Item -Path "$env:GITHUB_WORKSPACE\build\del.exe" -Destination $installerFolder -Force

      - name: Install WiX
        run: choco install wixtoolset --no-progress -y

      - name: Build MSI for ARM64
        shell: pwsh
        run: |
          Move-Item "$env:GITHUB_WORKSPACE\installer\del.exe\del.exe" "$env:GITHUB_WORKSPACE\installer\del.exe" -Force
          Set-Location $env:GITHUB_WORKSPACE
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
          Write-Host "== candle.exe =="
          & "$wixPath\candle.exe" installer\Product-arm64.wxs -ext WixUIExtension -dDelExePath="$env:GITHUB_WORKSPACE\installer\del.exe" -out installer\
          Write-Host "== light.exe =="
          & "$wixPath\light.exe" installer\Product-arm64.wixobj -ext WixUIExtension -o installer\DelAfterReboot-arm64.msi -b installer
      - name: Upload ARM64 MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-arm64
          path: installer/DelAfterReboot-arm64.msi

  release:
    runs-on: ubuntu-latest
    needs: [build-x86-x64, build-arm64]
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))

    steps:
      - uses: actions/checkout@v4

      - name: Download all MSI artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Read release info
        id: releaseinfo
        shell: bash
        run: |
          cd "$GITHUB_WORKSPACE"
          version=$(jq -r '.version // empty' release.json)
          notes=$(jq -r '.notes | join("\n")' release.json)
          if [ -z "$version" ]; then
            echo "version not found in release.json" >&2
            exit 1
          fi
          echo "VERSION=$version" >> "$GITHUB_ENV"
          {
            echo "NOTES<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_ENV"


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: ${{ env.NOTES }}
          files: |
            dist/**/DelAfterReboot-x86.msi
            dist/**/DelAfterReboot-x64.msi
            dist/**/DelAfterReboot-arm64.msi
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLISH_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [build-x86-x64, build-arm64]
    if: always()
    steps:
      - name: Build notification message
        id: build_msg
        run: |
          WORKFLOW_NAME="${{ github.workflow }}"
          REPO="${{ github.repository }}"
          STATUS="${{ needs.build-x86-x64.result }}-${{ needs.build-arm64.result }}"
          URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [[ "$STATUS" == "success-success" ]]; then
            MESSAGE=$'✅ Workflow *'"${WORKFLOW_NAME}"'* completed successfully.\nRepository: '"${REPO}"'\n[View Workflow]('"${URL}"')'
          else
            MESSAGE=$'❌ Workflow *'"${WORKFLOW_NAME}"'* finished with status: *'"${STATUS}"'*\nRepository: '"${REPO}"'\n[View Workflow]('"${URL}"')'
          fi

          printf '%s\n' "message<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$MESSAGE" >> "$GITHUB_OUTPUT"
          printf '%s\n' "EOF" >> "$GITHUB_OUTPUT"

      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          MESSAGE: ${{ steps.build_msg.outputs.message }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT}" \
            --data-urlencode "text=${MESSAGE}" \
            -d parse_mode="Markdown"
