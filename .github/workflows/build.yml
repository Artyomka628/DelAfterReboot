name: Build MSI and Release

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Publish to GitHub Release?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"
  push:
    branches:
      - main
    paths:
      - 'delafterreboot.cpp'
      - '.github/workflows/build.yml'

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  build:
    name: Build (matrix)
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_package: mingw-w64-i686-gcc
            runner: windows-latest
          - arch: x64
            msystem: MINGW64
            mingw_package: mingw-w64-x86_64-gcc
            runner: windows-latest
          - arch: arm64
            msystem: ""
            mingw_package: ""
            runner: windows-11-arm
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (x86/x64)
        if: ${{ matrix.arch != 'arm64' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: ${{ matrix.mingw_package }}

      - name: Setup llvm-mingw (arm64)
        if: ${{ matrix.arch == 'arm64' }}
        shell: pwsh
        run: |
          # download a known release; change URL if you need different version
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/20240130/llvm-mingw-20240130-ucrt-aarch64.zip"
          $zip = "llvm-mingw-aarch64.zip"
          Invoke-WebRequest -Uri $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath llvm-mingw -Force
          Remove-Item -Path $zip -Force

          # find directory that contains bin
          $binDir = Get-ChildItem -Path .\llvm-mingw -Directory -Recurse -ErrorAction SilentlyContinue | Where-Object { Test-Path (Join-Path $_.FullName 'bin') } | Select-Object -First 1
          if ($binDir) {
            $binPath = Join-Path $binDir.FullName 'bin'
          } else {
            $binPath = (Resolve-Path .\llvm-mingw\* | Select-Object -First 1).Path + '\bin'
          }

          Write-Host "Toolchain bin path: $binPath"
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$binPath`;$env:PATH"

      - name: Generate version header (PowerShell)
        shell: pwsh
        run: |
          $version = "unknown"
          $commit = "unknown"
          $date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          if (Test-Path "release.json") {
            try {
              $json = Get-Content release.json -Raw | ConvertFrom-Json
              if ($json.version) { $version = $json.version }
            } catch {}
          }

          try { $commit = git rev-parse --short HEAD } catch {}

          $content = @()
          $content += '#pragma once'
          $content += "#define APP_VERSION `"$version`""
          $content += "#define GIT_COMMIT_HASH `"$commit`""
          $content += "#define BUILD_DATE `"$date`""
          $content -join "`n" | Out-File -FilePath version.h -Encoding utf8

      - name: Build (x86/x64) using msys2
        if: ${{ matrix.arch != 'arm64' }}
        shell: msys2 {0}
        run: |
          set -e
          if [ "${{ matrix.arch }}" = "x86" ]; then
            export PATH="/mingw32/bin:$PATH"
          else
            export PATH="/mingw64/bin:$PATH"
          fi
          rm -rf dist
          mkdir -p dist
          g++ -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32

      - name: Build (arm64) using llvm-mingw
        if: ${{ matrix.arch == 'arm64' }}
        shell: pwsh
        run: |
          rm -Force -Recurse dist -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          aarch64-w64-mingw32-clang++ -std=c++17 -O2 -s -static -static-libgcc -static-libstdc++ -municode delafterreboot.cpp -o dist/delafterreboot.exe -ladvapi32 -lshell32 -luser32

      - name: Prepare Installer Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path installer -Force | Out-Null
          Move-Item -Path "dist/delafterreboot.exe" -Destination "installer/delafterreboot.exe" -Force

      - name: Install WiX Toolset
        shell: pwsh
        run: choco install wixtoolset --no-progress -y

      - name: Build MSI
        shell: pwsh
        run: |
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
          if (-not (Test-Path $wixPath)) {
            $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
          }
          $arch = "${{ matrix.arch }}"
          Write-Host "Using WiX path: $wixPath"
          & "$wixPath\candle.exe" "installer\Product-$arch.wxs" -ext WixUIExtension -dDelExePath="installer\delafterreboot.exe" -out "installer\$arch.wixobj"
          & "$wixPath\light.exe" "installer\$arch.wixobj" -ext WixUIExtension -o "installer\DelAfterReboot-$arch.msi" -b installer

      - name: Attest MSI provenance
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
          (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: installer/DelAfterReboot-${{ matrix.arch }}.msi

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DelAfterReboot-msi-${{ matrix.arch }}
          path: installer/DelAfterReboot-${{ matrix.arch }}.msi

  release_and_notify:
    name: Release and Notify
    runs-on: ubuntu-latest
    needs: build
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'yes') ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'Release'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all MSI artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Read Release Info
        id: releaseinfo
        shell: bash
        run: |
          version=$(jq -r '.version // empty' release.json)
          notes=$(jq -r '.notes | join("\n")' release.json)
          if [ -z "$version" ]; then
            echo "Version not found in release.json" >&2
            exit 1
          fi
          echo "VERSION=$version" >> "$GITHUB_ENV"
          {
            echo "NOTES<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: ${{ env.NOTES }}
          files: dist/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLISH_TOKEN }}

      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="success"
          REPO="${{ github.repository }}"
          URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE="âœ… Release v${{ env.VERSION }} published.\nRepository: ${REPO}\n[View workflow](${URL})"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT}" \
            --data-urlencode "text=${MESSAGE}" \
            -d parse_mode="Markdown"
